<!-- templates/survey/role_specific.html -->
{% extends "survey/base.html" %}
{% load static %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/role_specific_styles.css' %}">
    <script src="{% static 'js/role_specific_script.js' %}"></script>
{% endblock %}

{% block content %}
<h1 class="page-title">Role-Specific Questions</h1>

<div class="info-box">
    This section presents tailored questions based on your selected professional role(s).
    {% if is_legal and is_customs %}
    <p><strong>Note for Dual-Role Respondents:</strong> If you are both a Legal Practitioner and Customs Agent, please answer all relevant questions, but focus on unique challenges in each role to avoid redundancy.</p>
    {% endif %}
</div>

{% if error %}
<div class="error-box" id="error-box" role="alert">
    <div class="error-icon">‚ö†Ô∏è</div>
    <div class="error-message">{{ error }}</div>
</div>
{% endif %}

<form method="POST" id="roleSpecificForm" novalidate>
    {% csrf_token %}

    {% if is_legal %}
    <!-- Legal Practitioner Questions - FINALIZED VERSION -->
    <div class="section">
        <h2 class="section-title">‚öñÔ∏è Legal Practitioner Questions</h2>
        <p class="section-description">This section focuses on your experiences with FBR's digital systems for tax legal practice.</p>

        <!-- Section 1: Overall Digital Support -->
        <div class="subsection">
            <h3 class="subsection-title">üåü Overall Digital Support</h3>
            
            <!-- LP1 -->
            <div class="question-card">
                <div class="question-text">LP1. To what extent do FBR's digital systems currently support your effectiveness as a legal practitioner?</div>
                <div class="radio-group compact">
                    {% for value, label in lp1_options %}
                    <div class="radio-item">
                        <input type="radio" id="lp1_{{ value }}" name="lp1_digital_support" value="{{ value }}" required
                               {% if role_specific_answers.lp1_digital_support == value %}checked{% endif %}
                               aria-required="true">
                        <label for="lp1_{{ value }}">{{ label }}</label>
                    </div>
                    {% endfor %}
                </div>
                <div id="lp1_error_inline" class="validation-error-inline" style="display: none;" role="alert">
                    ‚ö†Ô∏è Please select an option for LP1.
                </div>
            </div>
        </div>

        <!-- Section 2: Functional Challenge Assessment -->
        <div class="subsection">
            <h3 class="subsection-title">üìä Functional Challenge Assessment</h3>
            
            <!-- LP2 - Representation & Appeals -->
            <div class="question-card">
                <div class="question-text">LP2. Please rate the level of challenge you face in these representation functions:</div>
                <div class="matrix-table-container">
                    <table class="matrix-table">
                        <thead>
                            <tr>
                                <th class="function-name">Function & Statute</th>
                                <th class="challenge-option">No Challenge</th>
                                <th class="challenge-option">Minor Challenge</th>
                                <th class="challenge-option">Moderate Challenge</th>
                                <th class="challenge-option">Major Challenge</th>
                                <th class="challenge-option">Don't Perform</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for function, statute, value, challenge_value in lp2_functions_with_data %}
                            <tr>
                                <td class="function-name">{{ function }}<br><small>{{ statute }}</small></td>
                                <td class="challenge-option">
                                    <input type="radio" name="lp2_{{ value }}" value="no_challenge" required
                                           {% if challenge_value == 'no_challenge' %}checked{% endif %}>
                                </td>
                                <td class="challenge-option">
                                    <input type="radio" name="lp2_{{ value }}" value="minor_challenge"
                                           {% if challenge_value == 'minor_challenge' %}checked{% endif %}>
                                </td>
                                <td class="challenge-option">
                                    <input type="radio" name="lp2_{{ value }}" value="moderate_challenge"
                                           {% if challenge_value == 'moderate_challenge' %}checked{% endif %}>
                                </td>
                                <td class="challenge-option">
                                    <input type="radio" name="lp2_{{ value }}" value="major_challenge"
                                           {% if challenge_value == 'major_challenge' %}checked{% endif %}>
                                </td>
                                <td class="challenge-option">
                                    <input type="radio" name="lp2_{{ value }}" value="dont_perform"
                                           {% if challenge_value == 'dont_perform' %}checked{% endif %}>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div id="lp2_error_inline" class="validation-error-inline" style="display: none;" role="alert">
                    ‚ö†Ô∏è Please complete all rows in LP2.
                </div>
            </div>

            <!-- LP3 - Compliance & Advisory -->
            <div class="question-card">
                <div class="question-text">LP3. Please rate the level of challenge you face in these compliance functions:</div>
                <div class="matrix-table-container">
                    <table class="matrix-table">
                        <thead>
                            <tr>
                                <th class="function-name">Function & Statute</th>
                                <th class="challenge-option">No Challenge</th>
                                <th class="challenge-option">Minor Challenge</th>
                                <th class="challenge-option">Moderate Challenge</th>
                                <th class="challenge-option">Major Challenge</th>
                                <th class="challenge-option">Don't Perform</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for function, statute, value, challenge_value in lp3_functions_with_data %}
                            <tr>
                                <td class="function-name">{{ function }}<br><small>{{ statute }}</small></td>
                                <td class="challenge-option">
                                    <input type="radio" name="lp3_{{ value }}" value="no_challenge" required
                                           {% if challenge_value == 'no_challenge' %}checked{% endif %}>
                                </td>
                                <td class="challenge-option">
                                    <input type="radio" name="lp3_{{ value }}" value="minor_challenge"
                                           {% if challenge_value == 'minor_challenge' %}checked{% endif %}>
                                </td>
                                <td class="challenge-option">
                                    <input type="radio" name="lp3_{{ value }}" value="moderate_challenge"
                                           {% if challenge_value == 'moderate_challenge' %}checked{% endif %}>
                                </td>
                                <td class="challenge-option">
                                    <input type="radio" name="lp3_{{ value }}" value="major_challenge"
                                           {% if challenge_value == 'major_challenge' %}checked{% endif %}>
                                </td>
                                <td class="challenge-option">
                                    <input type="radio" name="lp3_{{ value }}" value="dont_perform"
                                           {% if challenge_value == 'dont_perform' %}checked{% endif %}>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div id="lp3_error_inline" class="validation-error-inline" style="display: none;" role="alert">
                    ‚ö†Ô∏è Please complete all rows in LP3.
                </div>
            </div>

            <!-- LP4 - Dispute Resolution & Documentation -->
            <div class="question-card">
                <div class="question-text">LP4. Please rate the level of challenge you face in these dispute resolution functions:</div>
                <div class="matrix-table-container">
                    <table class="matrix-table">
                        <thead>
                            <tr>
                                <th class="function-name">Function & Statute</th>
                                <th class="challenge-option">No Challenge</th>
                                <th class="challenge-option">Minor Challenge</th>
                                <th class="challenge-option">Moderate Challenge</th>
                                <th class="challenge-option">Major Challenge</th>
                                <th class="challenge-option">Don't Perform</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for function, statute, value, challenge_value in lp4_functions_with_data %}
                            <tr>
                                <td class="function-name">{{ function }}<br><small>{{ statute }}</small></td>
                                <td class="challenge-option">
                                    <input type="radio" name="lp4_{{ value }}" value="no_challenge" required
                                           {% if challenge_value == 'no_challenge' %}checked{% endif %}>
                                </td>
                                <td class="challenge-option">
                                    <input type="radio" name="lp4_{{ value }}" value="minor_challenge"
                                           {% if challenge_value == 'minor_challenge' %}checked{% endif %}>
                                </td>
                                <td class="challenge-option">
                                    <input type="radio" name="lp4_{{ value }}" value="moderate_challenge"
                                           {% if challenge_value == 'moderate_challenge' %}checked{% endif %}>
                                </td>
                                <td class="challenge-option">
                                    <input type="radio" name="lp4_{{ value }}" value="major_challenge"
                                           {% if challenge_value == 'major_challenge' %}checked{% endif %}>
                                </td>
                                <td class="challenge-option">
                                    <input type="radio" name="lp4_{{ value }}" value="dont_perform"
                                           {% if challenge_value == 'dont_perform' %}checked{% endif %}>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div id="lp4_error_inline" class="validation-error-inline" style="display: none;" role="alert">
                    ‚ö†Ô∏è Please complete all rows in LP4.
                </div>
            </div>
        </div>

        <!-- Section 3: Tax-Type Impact & Improvements -->
        <div class="subsection">
            <h3 class="subsection-title">üéØ Tax-Type Impact & Improvements</h3>
            
            <!-- LP5 - Dynamic Tax-Type Grid -->
            
            <div class="question-card" id="lp5_section" style="display: none;">
                <div class="question-text">LP5. For your moderate and major challenges, please indicate which tax types are affected:</div>
                
                <!-- Debug the actual data -->
                <div style="display: none;" id="lp5_debug">
                    <p>Raw role_specific_answers.lp5_tax_types: {{ role_specific_answers.lp5_tax_types }}</p>
                    <p>Type: {{ role_specific_answers.lp5_tax_types|default:"None" }}</p>
                    <p>lp5_tax_types_json: {{ lp5_tax_types_json }}</p>
                    <p>lp5_tax_types_json length: {{ lp5_tax_types_json|length }}</p>
                </div>
                
                <!-- Use the properly formatted JSON from the view -->
                <input type="hidden" id="lp5_saved_data" value="{{ lp5_tax_types_json|safe }}">
                
                <div class="matrix-table-container">
                    <table class="matrix-table" id="lp5_tax_type_table">
                        <thead>
                            <tr>
                                <th class="function-name">Challenging Function</th>
                                <th class="tax-type-option">Income Tax</th>
                                <th class="tax-type-option">Sales Tax/FED</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- This will be populated dynamically by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div id="lp5_error_inline" class="validation-error-inline" style="display: none;" role="alert">
                    ‚ö†Ô∏è Please indicate tax types for your challenging functions.
                </div>
                <input type="hidden" id="lp5_visible" name="lp5_visible" value="0">
            </div>

            <!-- LP6 - Priority Improvement -->
            <div class="question-card">
                <div class="question-text">LP6. What ONE specific improvement would most enhance your legal practice with FBR? Please be specific about the change and its expected benefit.</div>
                <textarea name="lp6_priority_improvement" class="form-control textarea-qualitative" rows="4" required
                          placeholder="Describe the improvement and its expected benefit..."
                          aria-describedby="lp6_error_inline">{{ role_specific_answers.lp6_priority_improvement|default:'' }}</textarea>
                <div id="lp6_error_inline" class="validation-error-inline" style="display: none;" role="alert">
                    ‚ö†Ô∏è Please provide your priority improvement suggestion.
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if is_customs %}
    <!-- Customs Agent Questions - STREAMLINED VERSION -->
    <div class="section">
        <h2 class="section-title">üì¶ Customs Agent Questions</h2>
        <p class="section-description">This section focuses on your experiences with FBR's customs systems (WeBOC and PSW).</p>

        <!-- Section 1: Training & Systems -->
        <div class="subsection">
            <h3 class="subsection-title">üéì Training & Systems</h3>
            
            <!-- CA1 -->
            <div class="question-card">
                <div class="question-text">CA1. Have you received effective training on FBR's customs systems?</div>
                <div class="radio-group compact">
                    {% for value, label in ca1_options %}
                    <div class="radio-item">
                        <input type="radio" id="ca1_{{ value }}" name="ca1_training" value="{{ value }}" required
                            {% if role_specific_answers.ca1_training == value %}checked{% endif %}
                            aria-required="true">
                        <label for="ca1_{{ value }}">{{ label }}</label>
                    </div>
                    {% endfor %}
                </div>
                <div id="ca1_error_inline" class="validation-error-inline" style="display: none;" role="alert">
                    ‚ö†Ô∏è Please select an option for CA1.
                </div>
            </div>

            <!-- CA2 -->
            <div class="question-card">
                <div class="question-text">CA2. How well integrated are FBR's digital systems for your daily work?</div>
                <div class="radio-group compact">
                    {% for value, label in ca2_options %}
                    <div class="radio-item">
                        <input type="radio" id="ca2_{{ value }}" name="ca2_system_integration" value="{{ value }}" required
                            {% if role_specific_answers.ca2_system_integration == value %}checked{% endif %}
                            aria-required="true">
                        <label for="ca2_{{ value }}">{{ label }}</label>
                    </div>
                    {% endfor %}
                </div>
                <div id="ca2_error_inline" class="validation-error-inline" style="display: none;" role="alert">
                    ‚ö†Ô∏è Please select an option for CA2.
                </div>
            </div>
        </div>

        <!-- Section 2: Operational Challenges -->
        <div class="subsection">
            <h3 class="subsection-title">‚öôÔ∏è Operational Challenges</h3>
            
            <!-- CA3 - Customs Function Challenges Grid -->
            <div class="question-card">
                <div class="question-text">CA3. Please rate challenges in these key customs functions:</div>
                <div class="matrix-table-container">
                    <table class="matrix-table">
                        <thead>
                            <tr>
                                <th class="function-name">Function & Statute</th>
                                <th class="challenge-option">No Challenge</th>
                                <th class="challenge-option">Minor</th>
                                <th class="challenge-option">Moderate</th>
                                <th class="challenge-option">Major</th>
                                <th class="challenge-option">N/A</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for function, statute, value, challenge_value in ca3_functions_with_data %}
                            <tr>
                                <td class="function-name">{{ function }}<br><small>{{ statute }}</small></td>
                                <td class="challenge-option">
                                    <input type="radio" name="ca3_{{ value }}" value="no_challenge" required
                                           {% if challenge_value == 'no_challenge' %}checked{% endif %}>
                                </td>
                                <td class="challenge-option">
                                    <input type="radio" name="ca3_{{ value }}" value="minor_challenge"
                                           {% if challenge_value == 'minor_challenge' %}checked{% endif %}>
                                </td>
                                <td class="challenge-option">
                                    <input type="radio" name="ca3_{{ value }}" value="moderate_challenge"
                                           {% if challenge_value == 'moderate_challenge' %}checked{% endif %}>
                                </td>
                                <td class="challenge-option">
                                    <input type="radio" name="ca3_{{ value }}" value="major_challenge"
                                           {% if challenge_value == 'major_challenge' %}checked{% endif %}>
                                </td>
                                <td class="challenge-option">
                                    <input type="radio" name="ca3_{{ value }}" value="not_applicable"
                                           {% if challenge_value == 'not_applicable' %}checked{% endif %}>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div id="ca3_error_inline" class="validation-error-inline" style="display: none;" role="alert">
                    ‚ö†Ô∏è Please complete all rows in CA3.
                </div>
            </div>
        </div>

        <!-- Section 3: Process Effectiveness -->
        <div class="subsection">
            <h3 class="subsection-title">üìä Process Effectiveness</h3>
            
            <!-- CA4 - Process Ratings Grid -->
            <div class="question-card">
                <div class="question-text">CA4. How effective are these customs processes?</div>
                <div class="matrix-table-container">
                    <table class="matrix-table">
                        <thead>
                            <tr>
                                <th class="process-name">Process</th>
                                <th class="effectiveness-option">Very Effective</th>
                                <th class="effectiveness-option">Effective</th>
                                <th class="effectiveness-option">Neutral</th>
                                <th class="effectiveness-option">Ineffective</th>
                                <th class="effectiveness-option">Very Ineffective</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for process, value, effectiveness_value in ca4_processes_with_data %}
                            <tr>
                                <td class="process-name">{{ process }}</td>
                                <td class="effectiveness-option">
                                    <input type="radio" name="ca4_{{ value }}" value="very_effective" required
                                           {% if effectiveness_value == 'very_effective' %}checked{% endif %}>
                                </td>
                                <td class="effectiveness-option">
                                    <input type="radio" name="ca4_{{ value }}" value="effective"
                                           {% if effectiveness_value == 'effective' %}checked{% endif %}>
                                </td>
                                <td class="effectiveness-option">
                                    <input type="radio" name="ca4_{{ value }}" value="neutral"
                                           {% if effectiveness_value == 'neutral' %}checked{% endif %}>
                                </td>
                                <td class="effectiveness-option">
                                    <input type="radio" name="ca4_{{ value }}" value="ineffective"
                                           {% if effectiveness_value == 'ineffective' %}checked{% endif %}>
                                </td>
                                <td class="effectiveness-option">
                                    <input type="radio" name="ca4_{{ value }}" value="very_ineffective"
                                           {% if effectiveness_value == 'very_ineffective' %}checked{% endif %}>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div id="ca4_error_inline" class="validation-error-inline" style="display: none;" role="alert">
                    ‚ö†Ô∏è Please complete all rows in CA4.
                </div>
            </div>
        </div>

        <!-- Section 4: Impact & Improvements -->
        <div class="subsection">
            <h3 class="subsection-title">üéØ Impact & Improvements</h3>
            
            <!-- CA5 -->
            <div class="question-card">
                <div class="question-text">CA5. How have FBR changes affected your customs practice?</div>
                <div class="radio-group compact">
                    {% for value, label in ca5_options %}
                    <div class="radio-item">
                        <input type="radio" id="ca5_{{ value }}" name="ca5_policy_impact" value="{{ value }}" required
                            {% if role_specific_answers.ca5_policy_impact == value %}checked{% endif %}
                            aria-required="true">
                        <label for="ca5_{{ value }}">{{ label }}</label>
                    </div>
                    {% endfor %}
                </div>
                <div id="ca5_error_inline" class="validation-error-inline" style="display: none;" role="alert">
                    ‚ö†Ô∏è Please select an option for CA5.
                </div>
            </div>

            <!-- CA6 - Combined Challenge & Improvement -->
            <div class="question-card">
                <div class="question-text">CA6. What is your biggest challenge and what ONE improvement would help most?</div>
                
                <div class="form-group">
                    <label for="ca6_biggest_challenge" class="form-label">Biggest Challenge:</label>
                    <select id="ca6_biggest_challenge" name="ca6_biggest_challenge" class="form-control" required
                            aria-describedby="ca6_challenge_error_inline">
                        <option value="">Select your biggest challenge...</option>
                        {% for value, label in ca6_challenge_options %}
                        <option value="{{ value }}" {% if role_specific_answers.ca6_biggest_challenge == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                    <div id="ca6_challenge_error_inline" class="validation-error-inline" style="display: none;" role="alert">
                        ‚ö†Ô∏è Please select your biggest challenge.
                    </div>
                </div>

                <div class="form-group">
                    <label for="ca6_improvement" class="form-label">Specific Improvement Needed:</label>
                    <textarea id="ca6_improvement" name="ca6_improvement" class="form-control" rows="4" required
                              placeholder="Describe the specific improvement needed and how it would help..."
                              aria-describedby="ca6_improvement_error_inline">{{ role_specific_answers.ca6_improvement|default:'' }}</textarea>
                    <div id="ca6_improvement_error_inline" class="validation-error-inline" style="display: none;" role="alert">
                        ‚ö†Ô∏è Please describe the specific improvement needed.
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="buttons">
        <button type="button" class="btn btn-back" onclick="handleBackNavigation('{% url 'survey:generic_questions' %}')">‚Üê Back</button>
        <button type="submit" class="btn btn-next">Next ‚Üí</button>
    </div>
</form>
{% endblock %}